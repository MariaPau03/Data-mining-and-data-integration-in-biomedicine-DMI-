`BMI_Range` = paste0(bmi_min, "-", bmi_max),
`OTA_Mean ± SD` = paste0(ota_m, " ± ", ota_sd),
`OTA_Median (IQR)` = paste0(ota_med, " (", ota_q1, "-", ota_q3, ")"),
`OTA_Range` = paste0(ota_min, "-", ota_max),
`ATS_Mean ± SD` = paste0(ats_m, " ± ", ats_sd),
`ATS_Median (IQR)` = paste0(ats_med, " (", ats_q1, "-", ats_q3, ")"),
`ATS_Range` = paste0(ats_min, "-", ats_max)
)
}
# 4) Procesar cada grupo incluyendo el TOTAL
summary_groups <- df %>% group_by(group_label) %>% get_stats()
# A. Ensure the Total group is created correctly
summary_total <- df %>%
filter(group_label %in% c("Non-severe", "Severe")) %>%
mutate(group_label = "COVID-19 Total") %>% # Exact spelling is critical here
get_stats()
# B. Bind and Pivot
df_final <- bind_rows(summary_groups, summary_total) %>%
select(group_label, starts_with("Sex_"), starts_with("Age_"),
starts_with("BMI_"), starts_with("OTA_"), starts_with("ATS_")) %>%
mutate(across(everything(), as.character)) %>%
pivot_longer(-group_label, names_to = "Variable", values_to = "Value") %>%
mutate(Variable = str_remove(Variable, ".*_")) %>%
pivot_wider(names_from = group_label, values_from = Value)
# C. Now the select should work because the column name was created by pivot_wider
df_final <- df_final %>%
select(Variable, `Healthy Control`, `Non-COVID-19`, `COVID-19 Total`, `Non-severe`, `Severe`)
colnames(df_final)
# C. Now the select should work because the column name was created by pivot_wider
df_final <- df_final %>%
rename(`COVID-19 Total` = `NA`)
df_final <- df_final %>%
select(Variable, `Healthy Control`, `Non-COVID-19`, `COVID-19 Total`, `Non-severe`, `Severe`)
# 5) Limpiar celdas vacías o sin sentido (como tiempo de admisión en controles)
df_final[9:14, 2:3] <- "-" # OTA y ATS para controles
# 5) Limpiar celdas vacías o sin sentido (como tiempo de admisión en controles)
df_final <- df_final %>%
mutate(across(everything(), ~ map_chr(., ~ as.character(.x)[[1]] %||% NA_character_)))
df_final[9:14, 2:3] <- "-" # OTA y ATS para controles
df_final[12:14, 4]   <- "-" # ATS para Total (mezcla)
# 6) Crear la TABLA BONITA
df_final %>%
kbl(booktabs = TRUE, caption = "Tabla 1. Características Clínicas de los Pacientes") %>%
kable_classic(full_width = F, html_font = "Arial") %>%
pack_rows("Sex - no. (%)", 1, 2) %>%
pack_rows("Age - year", 3, 5) %>%
pack_rows("BMI, kg/m²", 6, 8) %>%
pack_rows("Time from Onset to Admission, Days", 9, 11) %>%
pack_rows("Time from Admission to Severe, Days", 12, 14) %>%
row_spec(0, bold = TRUE) %>%
column_spec(1, bold = TRUE, width = "8cm")
install.packages("tinytex")
install.packages("tinytex")
tinytex::install_tinytex()
#install.packages("knitr") #can execute R code inside the R markdown documents
#knitr::opts_chunk$set(echo = TRUE) #como se muestra el codigo, i TRUE significa que el cdigo R se muestra en el documento final (html, PDF,word)
#if (!require("knitr")) install.packages("knitr", repos = "http://cran.us.r-project.org")
library(knitr)
#Seeing the plot above, we can observe that there are many dots high above the rest of the group. To deal with them, we can: Remove, Transform (log the data pulls extreme outliers closer to the mean, making the distribution more normal), or use robust statistics ( use median and IQR instead of mean and SD. By using the median, this is more robust because it is not pulled away by a single extreme value)
# REMOVAL ---------------
#install.packages("ggstatsplot")
#install.packages("tidyverse")
#install.packages("patchwork")
library(tidyverse)
library(ggstatsplot)
library(patchwork)
mydata<- read_excel("../1-s2.0-S0092867420306279-mmc1.xlsx", sheet = 2)
getwd()
setwd("~/Desktop/Master/2nd TERM/DMI/H1")
getwd()
#Seeing the plot above, we can observe that there are many dots high above the rest of the group. To deal with them, we can: Remove, Transform (log the data pulls extreme outliers closer to the mean, making the distribution more normal), or use robust statistics ( use median and IQR instead of mean and SD. By using the median, this is more robust because it is not pulled away by a single extreme value)
# REMOVAL ---------------
#install.packages("ggstatsplot")
#install.packages("tidyverse")
#install.packages("patchwork")
library(tidyverse)
library(ggstatsplot)
library(patchwork)
mydata<- read_excel("../1-s2.0-S0092867420306279-mmc1.xlsx", sheet = 2)
#Seeing the plot above, we can observe that there are many dots high above the rest of the group. To deal with them, we can: Remove, Transform (log the data pulls extreme outliers closer to the mean, making the distribution more normal), or use robust statistics ( use median and IQR instead of mean and SD. By using the median, this is more robust because it is not pulled away by a single extreme value)
# REMOVAL ---------------
#install.packages("ggstatsplot")
#install.packages("tidyverse")
#install.packages("patchwork")
library(tidyverse)
library(ggstatsplot)
library(patchwork)
mydata<- read_excel("1-s2.0-S0092867420306279-mmc1.xlsx", sheet = 2)
#Seeing the plot above, we can observe that there are many dots high above the rest of the group. To deal with them, we can: Remove, Transform (log the data pulls extreme outliers closer to the mean, making the distribution more normal), or use robust statistics ( use median and IQR instead of mean and SD. By using the median, this is more robust because it is not pulled away by a single extreme value)
# REMOVAL ---------------
#install.packages("ggstatsplot")
#install.packages("tidyverse")
#install.packages("patchwork")
library(tidyverse)
library(ggstatsplot)
library(patchwork)
library(readxl)
mydata<- read_excel("1-s2.0-S0092867420306279-mmc1.xlsx", sheet = 2)
#Seeing the plot above, we can observe that there are many dots high above the rest of the group. To deal with them, we can: Remove, Transform (log the data pulls extreme outliers closer to the mean, making the distribution more normal), or use robust statistics ( use median and IQR instead of mean and SD. By using the median, this is more robust because it is not pulled away by a single extreme value)
# REMOVAL ---------------
#install.packages("ggstatsplot")
#install.packages("tidyverse")
#install.packages("patchwork")
library(tidyverse)
library(ggstatsplot)
library(patchwork)
library(readxl)
mydata<- read_excel("../1-s2.0-S0092867420306279-mmc1.xlsx", sheet = 2)
mydata <- clean_names(mydata)
#Seeing the plot above, we can observe that there are many dots high above the rest of the group. To deal with them, we can: Remove, Transform (log the data pulls extreme outliers closer to the mean, making the distribution more normal), or use robust statistics ( use median and IQR instead of mean and SD. By using the median, this is more robust because it is not pulled away by a single extreme value)
# REMOVAL ---------------
#install.packages("ggstatsplot")
#install.packages("tidyverse")
#install.packages("patchwork")
library(tidyverse)
library(ggstatsplot)
library(patchwork)
library(readxl)
library(janitor)
mydata<- read_excel("../1-s2.0-S0092867420306279-mmc1.xlsx", sheet = 2)
mydata <- clean_names(mydata)
# Define the variables in the EXACT order you want them to appear in the grid
ordered_vars <- c(
"wbc_count_109_l", "lymphocyte_count_109_l", "monocyte_count_109_l",
"platelet_count_109_l", "crp_i_mg_l", "alt_j_u_l",
"ast_k_u_l",
"ggt_l_u_l",
"tbil_m_mmol_l",
"dbil_n_mmol_l",
"creatinine_mmol_l",
"glucose_mmol_l"
)
# Data Processing Pipeline
mydata_ordered <- mydata %>%
# Grouping logic
mutate(
group = case_when(
group_d %in% c(0, 1) ~ "Non-COVID-19",
group_d == 2 ~ "Non-severe",
group_d == 3 ~ "Severe",
TRUE ~ NA_character_
),
group = factor(group, levels = c("Non-COVID-19", "Non-severe", "Severe"))
) %>%
filter(!is.na(group)) %>%
# Convert measurements to numeric
mutate(across(all_of(ordered_vars), as.numeric)) %>%
select(group, all_of(ordered_vars)) %>%
# Pivot to long format
pivot_longer(cols = -group, names_to = "measurement", values_to = "value") %>%
# Convert measurement to a factor using the order defined above
mutate(measurement = factor(measurement, levels = ordered_vars)) %>%
# Outlier cleaning (per group and per marker)
group_by(group, measurement) %>%
mutate(
q1 = quantile(value, 0.25, na.rm = TRUE),
q3 = quantile(value, 0.75, na.rm = TRUE),
iqr = q3 - q1,
up = q3 + (1.5 * iqr),
low = q1 - (1.5 * iqr),
cleaned_value = ifelse(value > up | value < low, NA, value)
) %>%
ungroup()
# Final Plotting
s <- ggplot(mydata_ordered, aes(x = group, y = cleaned_value, color = group)) +
stat_summary(fun = "mean", geom = "bar", fill = "white", linewidth = 1, width = 0.7) +
stat_summary(fun.data = "mean_se", geom = "errorbar", width = 0.2, color = "black") +
geom_jitter(width = 0.2, alpha = 0.5, size = 0.8) +
# Facet using the factor (which now follows our custom order)
facet_wrap(~measurement, scales = "free_y", ncol = 3) +
scale_color_manual(values = c(
"Non-COVID-19" = "#4A69BD",
"Non-severe"   = "#F6B93B",
"Severe"       = "#B71C1C"
)) +
theme_classic() +
theme(
strip.background = element_blank(),
strip.text = element_text(face = "bold"), # Makes labels clearer
legend.position = "top",
axis.text.x = element_blank(),
axis.ticks.x = element_blank()
) +
labs(title = "Supplementary Figure 1 (Ordered & Cleaned)", y = "Value", x = NULL)
ggsave("SuppFig1_2_2.png", s, width = 14, height = 12, dpi = 300)
s
#Count removed outliers
outlier_summary <- mydata_ordered %>%
group_by(measurement, group) %>%
summarise(
total_samples = n(),
outliers_removed = sum(is.na(cleaned_value) & !is.na(value)),
percent_removed = (outliers_removed / total_samples) * 100
) %>%
filter(outliers_removed > 0) # Only show markers that actually had outliers
view(outlier_summary)
#install.packages("pheatmap")
library(pheatmap)
library(tidyverse)
library(ggplot2)
# 1. Take cleaned "mydata_ordered" and pivot it back to wide format
heatmap_ready <- mydata_ordered %>%
select(group, measurement, cleaned_value) %>%
# We need an ID to pivot back correctly.
# If you lost patient_id_a in the previous step, make sure to keep it in the pipeline!
group_by(measurement, group) %>%
mutate(row_id = row_number()) %>%
pivot_wider(names_from = measurement, values_from = cleaned_value) %>%
ungroup() %>%
drop_na() # Heatmaps cannot handle NA values easily; pheatmap will fail
View(heatmap_ready)
# 2. Prepare Annotation
annotation_col <- heatmap_ready %>%
select(group) %>%
as.data.frame()
View(annotation_col)
# 3. Create the Matrix
matrix_to_plot <- heatmap_ready %>%
select(all_of(ordered_vars)) %>%
as.matrix()
View(matrix_to_plot)
# 4. Plot
## 1. Convert everything to standard data frames immediately
matrix_df <- as.data.frame(matrix_to_plot)
View(matrix_to_plot)
## 2. Handle the NAs (Outliers)
# Since I have 51 patients in my matrix, we need to make sure
# the annotation table also has exactly those 51 patients.
rows_to_keep <- complete.cases(matrix_df)
matrix_to_plot_clean <- matrix_df[rows_to_keep, ]
annotation_col_clean <- annotation_col[rows_to_keep, , drop = FALSE]
View(annotation_col)
## 3. Assign matching dummy names so pheatmap can't miss them
patient_names <- paste0("Patient_", 1:nrow(matrix_to_plot_clean))
rownames(matrix_to_plot_clean) <- patient_names
rownames(annotation_col_clean) <- patient_names
View(annotation_col_clean)
## 4. Check the counts again
print(paste("Matrix columns:", ncol(t(matrix_to_plot_clean))))
print(paste("Annotation rows:", nrow(annotation_col_clean)))
View(matrix_to_plot_clean)
## 5. Plot
h <- pheatmap(
t(matrix_to_plot_clean),
scale = "row",
annotation_col = annotation_col_clean,
show_colnames = FALSE,
main = "Heatmap (Outliers Removed)"
)
h
View(h)
h
h
# Make sure group and sex are in your annotation data
annotation_col <- heatmap_ready[rows_to_keep, ] %>%
select(group, sex) %>%
as.data.frame()
# 1. Take cleaned "mydata_ordered" and pivot it back to wide format
heatmap_ready <- mydata_ordered %>%
select(group, sex, measurement, cleaned_value) %>%
# We need an ID to pivot back correctly.
group_by(measurement, group) %>%
mutate(row_id = row_number()) %>%
pivot_wider(names_from = measurement, values_from = cleaned_value) %>%
ungroup() %>%
drop_na() # Heatmaps cannot handle NA values easily; pheatmap will fail
colnames(mydata_ordered)
colnames(mydata)
# 1. Take cleaned "mydata_ordered" and pivot it back to wide format
mydata_long <- mydata %>%
select(patient_id_a, group = group_d, sex = sex_g, all_of(ordered_vars)) %>%
pivot_longer(cols = all_of(ordered_vars),
names_to = "measurement",
values_to = "value")
# 1. Take cleaned "mydata_ordered" and pivot it back to wide format
mydata_long <- mydata %>%
select(patient_id_a, group = group_d, sex = sex_g, all_of(ordered_vars)) %>%
mutate(across(all_of(ordered_vars), ~as.numeric(as.character(.)))) %>%
pivot_longer(cols = all_of(ordered_vars),
names_to = "measurement",
values_to = "value") %>%
drop_na(value)
heatmap_ready <- mydata_long %>%
drop_na(value) %>%
pivot_wider(names_from = measurement, values_from = value) %>%
drop_na() # Heatmaps cannot handle NA values easily; pheatmap will fail
# 2. Prepare Annotation
annotation_col <- heatmap_ready %>%
select(group, sex) %>%
as.data.frame()
View(annotation_col)
heatmap_ready <- heatmap_ready %>%
# Grouping logic
mutate(
group = case_when(
group_d %in% c(0, 1) ~ "Non-COVID-19",
group_d == 2 ~ "Non-severe",
group_d == 3 ~ "Severe",
TRUE ~ NA_character_
),
group = factor(group, levels = c("Non-COVID-19", "Non-severe", "Severe"))
) %>%
filter(!is.na(group)) %>%
# 2. Prepare Annotation
annotation_col <- heatmap_ready %>%
select(group, sex) %>%
as.data.frame()
heatmap_ready <- heatmap_ready %>%
# Grouping logic
mutate(
group = case_when(
group %in% c(0, 1) ~ "Non-COVID-19",
group == 2 ~ "Non-severe",
group == 3 ~ "Severe",
TRUE ~ NA_character_
),
group = factor(group, levels = c("Non-COVID-19", "Non-severe", "Severe"))
) %>%
filter(!is.na(group)) %>%
# 2. Prepare Annotation
annotation_col <- heatmap_ready %>%
select(group, sex) %>%
as.data.frame()
heatmap_ready <- heatmap_ready %>%
# Grouping logic
mutate(
group = case_when(
group %in% c(0, 1) ~ "Non-COVID-19",
group == 2 ~ "Non-severe",
group == 3 ~ "Severe",
TRUE ~ NA_character_
),
group = factor(group, levels = c("Non-COVID-19", "Non-severe", "Severe"))
)
# 2. Prepare Annotation
annotation_col <- heatmap_ready %>%
select(group, sex) %>%
as.data.frame()
# 2. Prepare Annotation
annotation_col <- heatmap_ready %>%
select(group, sex) %>%
as.data.frame()
View(annotation_col)
# 3. Create the Matrix
matrix_to_plot <- heatmap_ready %>%
select(all_of(ordered_vars)) %>%
as.matrix()
# Make sure group and sex are in your annotation data
annotation_col <- heatmap_ready[rows_to_keep, ] %>%
select(group, sex) %>%
as.data.frame()
## 3. Assign matching dummy names so pheatmap can't miss them
patient_names <- paste0("Patient_", 1:nrow(matrix_to_plot_clean))
rownames(matrix_to_plot_clean) <- patient_names
rownames(annotation_col_clean) <- patient_names
## 5. Plot
h <- pheatmap(
t(matrix_to_plot_clean), #as I'm transposing, the biomarkers are now in the rows
scale = "row", # tells R to calculate the z-score for each biomarker, substracting the mean and dividing them by the sd
annotation_col = annotation_col_clean,
show_colnames = FALSE,
main = "Heatmap (Outliers Removed)"
)
h
h
#As biomarkers have very different units, units must be scaled so all of them are compared ona relative basis. This is done in the pheatmap function to do the heatmap
#by grouping by group, allows to see if "severe" patients have a distinct color pattern compared to the "healthy" controls
#grouping by gender, helps identify if biomarker patterns are influenced by biological sex.
#install.packages("pheatmap")
library(pheatmap)
library(tidyverse)
library(ggplot2)
# 1. Take cleaned "mydata_ordered" and pivot it back to wide format
mydata_long <- mydata %>%
select(patient_id_a, group = group_d, sex = sex_g, all_of(ordered_vars)) %>%
mutate(across(all_of(ordered_vars), ~as.numeric(as.character(.)))) %>%
pivot_longer(cols = all_of(ordered_vars),
names_to = "measurement",
values_to = "value") %>%
drop_na(value)
heatmap_ready <- mydata_long %>%
drop_na(value) %>%
pivot_wider(names_from = measurement, values_from = value) %>%
drop_na() # Heatmaps cannot handle NA values easily; pheatmap will fail
heatmap_ready <- heatmap_ready %>%
# Grouping logic
mutate(
group = case_when(
group %in% c(0, 1) ~ "Non-COVID-19",
group == 2 ~ "Non-severe",
group == 3 ~ "Severe",
TRUE ~ NA_character_
),
group = factor(group, levels = c("Non-COVID-19", "Non-severe", "Severe"))
)
# 2. Prepare Annotation
annotation_col <- heatmap_ready %>%
select(group, sex) %>%
as.data.frame()
# 3. Create the Matrix
matrix_to_plot <- heatmap_ready %>%
select(all_of(ordered_vars)) %>%
as.matrix()
# 4. Plot
## 1. Convert everything to standard data frames immediately
matrix_df <- as.data.frame(matrix_to_plot)
# Make sure group and sex are in your annotation data
# annotation_col <- heatmap_ready[rows_to_keep, ] %>%
#   select(group, sex) %>%
#   as.data.frame()
## 2. Handle the NAs (Outliers)
# Since I have 51 patients in my matrix, we need to make sure
# the annotation table also has exactly those 51 patients.
# rows_to_keep <- complete.cases(matrix_df)
# matrix_to_plot_clean <- matrix_df[rows_to_keep, ]
# annotation_col_clean <- annotation_col[rows_to_keep, , drop = FALSE]
## 3. Assign matching dummy names
# Use matrix_to_plot (the one you created in Step 3)
patient_names <- paste0("Patient_", 1:nrow(matrix_to_plot))
rownames(matrix_to_plot) <- patient_names
rownames(annotation_col) <- patient_names
## 4. Check the counts
print(paste("Matrix rows (patients):", nrow(matrix_to_plot)))
print(paste("Annotation rows:", nrow(annotation_col)))
## 5. Plot
h <- pheatmap(
t(matrix_to_plot), # Biomarkers in rows
scale = "row",     # Z-score scaling
annotation_col = annotation_col,
show_colnames = FALSE,
main = "Heatmap: Clinical Biomarkers by Group and Sex"
)
h
#ggsave("Heatmap.png", h, width = 14, height = 12, dpi = 300)
h
#As biomarkers have very different units, units must be scaled so all of them are compared ona relative basis. This is done in the pheatmap function to do the heatmap
#by grouping by group, allows to see if "severe" patients have a distinct color pattern compared to the "healthy" controls
#grouping by gender, helps identify if biomarker patterns are influenced by biological sex.
#install.packages("pheatmap")
library(pheatmap)
library(tidyverse)
library(ggplot2)
# 1. Take cleaned "mydata_ordered" and pivot it back to wide format
mydata_long <- mydata %>%
select(patient_id_a, group = group_d, sex = sex_g, all_of(ordered_vars)) %>%
mutate(across(all_of(ordered_vars), ~as.numeric(as.character(.)))) %>%
pivot_longer(cols = all_of(ordered_vars),
names_to = "measurement",
values_to = "value") %>%
drop_na(value)
heatmap_ready <- mydata_long %>%
drop_na(value) %>%
pivot_wider(names_from = measurement, values_from = value) %>%
drop_na() # Heatmaps cannot handle NA values easily; pheatmap will fail
heatmap_ready <- heatmap_ready %>%
mutate(
# Existing grouping logic
group = case_when(
group %in% c(0, 1) ~ "Non-COVID-19",
group == 2 ~ "Non-severe",
group == 3 ~ "Severe",
TRUE ~ NA_character_
),
group = factor(group, levels = c("Non-COVID-19", "Non-severe", "Severe")),
# NEW: Convert 0/1 to Female/Male
sex = case_when(
sex == 0 ~ "Female",
sex == 1 ~ "Male",
TRUE ~ as.character(sex)
)
)
# 2. Prepare Annotation
annotation_col <- heatmap_ready %>%
select(group, sex) %>%
as.data.frame()
# 3. Create the Matrix
matrix_to_plot <- heatmap_ready %>%
select(all_of(ordered_vars)) %>%
as.matrix()
# 4. Plot
## 1. Convert everything to standard data frames immediately
matrix_df <- as.data.frame(matrix_to_plot)
# Make sure group and sex are in your annotation data
# annotation_col <- heatmap_ready[rows_to_keep, ] %>%
#   select(group, sex) %>%
#   as.data.frame()
## 2. Handle the NAs (Outliers)
# Since I have 51 patients in my matrix, we need to make sure
# the annotation table also has exactly those 51 patients.
# rows_to_keep <- complete.cases(matrix_df)
# matrix_to_plot_clean <- matrix_df[rows_to_keep, ]
# annotation_col_clean <- annotation_col[rows_to_keep, , drop = FALSE]
## 3. Assign matching dummy names
# Use matrix_to_plot (the one you created in Step 3)
patient_names <- paste0("Patient_", 1:nrow(matrix_to_plot))
rownames(matrix_to_plot) <- patient_names
rownames(annotation_col) <- patient_names
## 4. Check the counts
print(paste("Matrix rows (patients):", nrow(matrix_to_plot)))
print(paste("Annotation rows:", nrow(annotation_col)))
## 5. Plot
h <- pheatmap(
t(matrix_to_plot), # Biomarkers in rows
scale = "row",     # Z-score scaling
annotation_col = annotation_col,
show_colnames = FALSE,
main = "Heatmap: Clinical Biomarkers by Group and Sex"
)
h
#ggsave("Heatmap.png", h, width = 14, height = 12, dpi = 300)
H
h
